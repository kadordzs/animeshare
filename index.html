<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شاهدوا معًا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        #player-container { position: relative; width: 100%; padding-top: 56.25%; }
        #player, #iframe-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #chat-messages::-webkit-scrollbar, #online-users::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-track, #online-users::-webkit-scrollbar-track { background: #2d3748; }
        #chat-messages::-webkit-scrollbar-thumb, #online-users::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        #chat-messages::-webkit-scrollbar-thumb:hover, #online-users::-webkit-scrollbar-thumb:hover { background: #718096; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="flex flex-col lg:flex-row h-screen">
        <!-- Main Content (Video) -->
        <main class="w-full lg:w-2/3 p-4 flex flex-col">
            <header class="text-center my-4">
                <h1 class="text-4xl font-bold text-red-500">شاهدوا معًا</h1>
                <p id="status-message" class="text-yellow-400 mt-2">جارِ الاتصال...</p>
            </header>

            <div class="flex flex-col sm:flex-row gap-2 mb-4">
                <input id="video-url-input" type="text" placeholder="الصق رابط فيديو يوتيوب أو أي موقع آخر هنا..." class="flex-grow bg-gray-800 text-white p-3 rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-all">
                <button id="load-video-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-md transition-colors duration-300">تحميل الفيديو</button>
            </div>
            
            <div id="player-container" class="bg-black rounded-lg shadow-2xl overflow-hidden flex-grow">
                <div id="player"></div>
                <iframe id="iframe-player" class="hidden" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                <div id="placeholder" class="w-full h-full flex items-center justify-center bg-gray-800">
                    <div class="text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.55a2 2 0 010 3.8l-4.55 2.2M4 6h8a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" /></svg>
                        <p class="mt-2">الفيديو سيظهر هنا</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar (Chat & Info) -->
        <aside class="w-full lg:w-1/3 bg-gray-800 flex flex-col p-4 border-r-2 border-gray-700 h-screen lg:h-auto">
            <div class="bg-gray-900 p-4 rounded-lg mb-4">
                <div class="text-center mb-4">
                    <h2 class="text-lg font-semibold mb-2">شارك هذه الجلسة</h2>
                    <div class="flex items-center justify-center bg-gray-700 rounded-md p-2">
                        <input id="session-link" type="text" class="bg-transparent text-white w-full text-center focus:outline-none" readonly>
                        <button id="copy-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md mr-2 transition-colors duration-300">نسخ</button>
                    </div>
                    <p id="copy-success" class="text-green-400 mt-2 h-4"></p>
                </div>
                 <div class="text-center">
                    <p class="text-xs text-gray-400">اسمك (اضغط للتغيير):</p>
                    <p id="user-name-display" class="text-lg text-green-400 break-all cursor-pointer hover:text-green-300 transition-colors">غير متصل</p>
                </div>
            </div>
            
            <!-- Online Users -->
            <div class="bg-gray-900 rounded-lg mb-4">
                <h2 class="text-xl font-bold p-4 text-center border-b border-gray-700">المتواجدون الآن</h2>
                <div id="online-users" class="p-4 overflow-y-auto max-h-32">
                    <!-- Online users list will be here -->
                </div>
            </div>

            <!-- Chat -->
            <div class="flex-grow flex flex-col bg-gray-900 rounded-lg">
                <h2 class="text-xl font-bold p-4 text-center border-b border-gray-700">المحادثة</h2>
                <div id="chat-messages" class="flex-grow p-4 overflow-y-auto"></div>
                <form id="chat-form" class="p-4 border-t border-gray-700 flex gap-2">
                    <input id="chat-input" type="text" placeholder="اكتب رسالتك..." class="flex-grow bg-gray-700 text-white p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition-colors">إرسال</button>
                </form>
            </div>
        </aside>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, serverTimestamp, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAIoruD5BJKkDVpaQqBxgjKi4Gga5FoyqI",
            authDomain: "shereanime-a5ba4.firebaseapp.com",
            projectId: "shereanime-a5ba4",
            storageBucket: "shereanime-a5ba4.appspot.com",
            messagingSenderId: "1099067763175",
            appId: "1:1099067763175:web:fd9c77c365b5605d2a7542",
            measurementId: "G-MMQ1LM3XH3"
        };
        
        // --- DOM Elements ---
        const elements = {
            videoUrlInput: document.getElementById('video-url-input'),
            loadVideoButton: document.getElementById('load-video-button'),
            sessionLinkInput: document.getElementById('session-link'),
            copyButton: document.getElementById('copy-button'),
            copySuccessMessage: document.getElementById('copy-success'),
            playerDiv: document.getElementById('player'),
            iframePlayer: document.getElementById('iframe-player'),
            placeholderDiv: document.getElementById('placeholder'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            chatMessages: document.getElementById('chat-messages'),
            userNameDisplay: document.getElementById('user-name-display'),
            onlineUsers: document.getElementById('online-users'),
            statusMessage: document.getElementById('status-message'),
        };

        // --- App State ---
        let appState = {
            db: null,
            auth: null,
            player: null,
            sessionId: null,
            sessionDocRef: null,
            usersColRef: null, // For presence
            messagesColRef: null,
            userId: null,
            userName: null,
            localUpdate: false,
            sessionUnsubscribe: null,
            messagesUnsubscribe: null,
            usersUnsubscribe: null,
        };

        // --- Main App Logic ---
        function main() {
            try {
                const app = initializeApp(firebaseConfig);
                appState.db = getFirestore(app);
                appState.auth = getAuth(app);
                handleAuthentication();
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                elements.statusMessage.textContent = "فشل تهيئة Firebase. تأكد من صحة الإعدادات.";
                elements.statusMessage.classList.replace('text-yellow-400', 'text-red-500');
            }
        }

        function handleAuthentication() {
            onAuthStateChanged(appState.auth, async (user) => {
                if (user) {
                    appState.userId = user.uid;
                    await setupUser();
                    elements.statusMessage.textContent = "متصل! جارِ تحميل الجلسة...";
                    elements.statusMessage.classList.replace('text-yellow-400', 'text-green-400');
                    setupSession();
                } else {
                    elements.statusMessage.textContent = "جارِ تسجيل الدخول...";
                    try {
                        await signInAnonymously(appState.auth);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        elements.statusMessage.textContent = "فشل تسجيل الدخول. تأكد من تفعيل 'Anonymous sign-in' في Firebase.";
                        elements.statusMessage.classList.replace('text-yellow-400', 'text-red-500');
                    }
                }
            });
        }
        
        async function setupUser() {
            let savedName = localStorage.getItem('watchTogetherUserName');
            if (!savedName) {
                savedName = prompt("الرجاء إدخال اسمك للمحادثة:") || `مستخدم-${Math.floor(Math.random() * 1000)}`;
                localStorage.setItem('watchTogetherUserName', savedName);
            }
            appState.userName = savedName;
            elements.userNameDisplay.textContent = appState.userName;
        }

        function setupSession() {
            const urlParams = new URLSearchParams(window.location.search);
            let currentSessionId = urlParams.get('session');
            let shareableLink = window.location.href; 
            
            if (!currentSessionId) {
                currentSessionId = `${appState.userId}-${Date.now()}`;
                const baseUrl = window.location.href.split('?')[0];
                shareableLink = `${baseUrl}?session=${currentSessionId}`;
            }

            appState.sessionId = currentSessionId;
            elements.sessionLinkInput.value = shareableLink;
            
            appState.sessionDocRef = doc(appState.db, "sessions", appState.sessionId);
            appState.messagesColRef = collection(appState.sessionDocRef, "messages");
            appState.usersColRef = collection(appState.sessionDocRef, "users");

            managePresence();
            attachListeners();
        }

        async function managePresence() {
            const userStatusRef = doc(appState.usersColRef, appState.userId);
            
            // Using Realtime Database for more reliable disconnects if needed, but Firestore is simpler here.
            // For now, a simple Firestore presence.
            await setDoc(userStatusRef, { name: appState.userName, online: true });
            
            window.addEventListener('beforeunload', () => {
                deleteDoc(userStatusRef);
            });
        }

        function attachListeners() {
            // Detach old listeners
            if (appState.sessionUnsubscribe) appState.sessionUnsubscribe();
            if (appState.messagesUnsubscribe) appState.messagesUnsubscribe();
            if (appState.usersUnsubscribe) appState.usersUnsubscribe();

            // Session state listener
            appState.sessionUnsubscribe = onSnapshot(appState.sessionDocRef, (snapshot) => {
                elements.statusMessage.textContent = "الجلسة جاهزة للمشاهدة!";
                elements.statusMessage.classList.replace('text-yellow-400', 'text-green-400');
                if (appState.localUpdate) { appState.localUpdate = false; return; }
                const data = snapshot.exists() ? snapshot.data() : {};
                if (data.videoUrl && data.videoUrl !== elements.videoUrlInput.getAttribute('data-current-url')) {
                    renderVideo(data.videoUrl, data.type);
                }
                syncPlayerState(data);
            }, (error) => {
                console.error("Session listener error:", error);
                elements.statusMessage.textContent = "خطأ في الاتصال بالجلسة.";
                elements.statusMessage.classList.replace('text-green-400', 'text-red-500');
            });

            // Online users listener
            appState.usersUnsubscribe = onSnapshot(appState.usersColRef, (snapshot) => {
                elements.onlineUsers.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userEl = document.createElement('div');
                    userEl.textContent = user.name;
                    userEl.classList.add('text-gray-300', 'p-1');
                    elements.onlineUsers.appendChild(userEl);
                });
            });

            // Chat messages listener
            appState.messagesUnsubscribe = onSnapshot(query(appState.messagesColRef), (snapshot) => {
                const allMessages = [];
                snapshot.forEach(doc => allMessages.push({ ...doc.data(), id: doc.id }));
                allMessages.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                elements.chatMessages.innerHTML = '';
                allMessages.forEach(addMessageToDOM);
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            });
        }
        
        function syncPlayerState(data) {
             if (appState.player && data.type === 'youtube' && appState.player.getPlayerState) {
                const playerState = appState.player.getPlayerState();
                if (data.isPlaying && playerState !== YT.PlayerState.PLAYING) { appState.player.playVideo(); } 
                else if (!data.isPlaying && playerState !== YT.PlayerState.PAUSED) { appState.player.pauseVideo(); }
                if (appState.player.getCurrentTime) {
                   const timeDifference = Math.abs((data.currentTime || 0) - (appState.player.getCurrentTime() || 0));
                    if (timeDifference > 2.5) { appState.player.seekTo(data.currentTime, true); }
                }
            }
        }

        function addMessageToDOM(message) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('mb-3', 'p-3', 'rounded-lg', 'w-fit', 'max-w-xs', 'break-words');
            const isMe = message.senderId === appState.userId;
            messageEl.classList.add(isMe ? 'bg-red-700' : 'bg-gray-600', isMe ? 'ml-auto' : 'mr-auto');
            messageEl.innerHTML = `<p class="font-bold text-sm">${message.senderName || 'مستخدم'}</p><p class="text-white mt-1">${message.text}</p>`;
            elements.chatMessages.appendChild(messageEl);
        }

        async function updateFirestoreState(newState) {
            if (!appState.sessionDocRef) return;
            appState.localUpdate = true;
            try { 
                await setDoc(appState.sessionDocRef, newState, { merge: true }); 
            } catch (error) { 
                console.error("Error updating Firestore:", error); 
                elements.statusMessage.textContent = "فشل تحديث الحالة.";
            }
        }
        
        window.onYouTubeIframeAPIReady = () => console.log("YouTube API Ready.");

        function createYouTubePlayer(videoId) {
            if (appState.player) {
                appState.player.loadVideoById(videoId);
            } else {
                appState.player = new YT.Player('player', {
                    height: '100%', width: '100%', videoId: videoId,
                    playerVars: { 'playsinline': 1, 'autoplay': 1, 'controls': 1, 'rel': 0 },
                    events: { 'onReady': (e) => e.target.playVideo(), 'onStateChange': onPlayerStateChange }
                });
            }
        }
        
        function onPlayerStateChange(event) {
            const isPlaying = (event.data === YT.PlayerState.PLAYING);
            updateFirestoreState({ isPlaying: isPlaying, currentTime: event.target.getCurrentTime() });
        }
        
        function getYouTubeVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function renderVideo(url, type) {
            elements.videoUrlInput.value = url;
            elements.videoUrlInput.setAttribute('data-current-url', url);
            elements.placeholderDiv.classList.add('hidden');
            
            if (type === 'youtube') {
                const videoId = getYouTubeVideoId(url);
                elements.iframePlayer.classList.add('hidden');
                elements.playerDiv.classList.remove('hidden');
                createYouTubePlayer(videoId);
            } else {
                if (appState.player) { appState.player.destroy(); appState.player = null; }
                elements.playerDiv.classList.add('hidden');
                elements.iframePlayer.src = url;
                elements.iframePlayer.classList.remove('hidden');
            }
        }
        
        // --- Event Listeners Setup ---
        elements.loadVideoButton.addEventListener('click', () => {
            const url = elements.videoUrlInput.value.trim();
            if (!url) return;
            const videoId = getYouTubeVideoId(url);
            updateFirestoreState({ videoUrl: url, type: videoId ? 'youtube' : 'iframe', currentTime: 0, isPlaying: true });
        });

        elements.copyButton.addEventListener('click', () => {
            elements.sessionLinkInput.select();
            document.execCommand('copy');
            elements.copySuccessMessage.textContent = 'تم نسخ الرابط!';
            setTimeout(() => { elements.copySuccessMessage.textContent = '' }, 2000);
        });
        
        elements.chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = elements.chatInput.value.trim();
            if (messageText) {
                elements.chatInput.value = '';
                await addDoc(appState.messagesColRef, { 
                    text: messageText, 
                    senderId: appState.userId,
                    senderName: appState.userName,
                    createdAt: serverTimestamp() 
                });
            }
        });
        
        elements.userNameDisplay.addEventListener('click', async () => {
            const newName = prompt("أدخل اسمك الجديد:", appState.userName);
            if (newName && newName.trim() !== "") {
                appState.userName = newName.trim();
                localStorage.setItem('watchTogetherUserName', appState.userName);
                elements.userNameDisplay.textContent = appState.userName;
                await setDoc(doc(appState.usersColRef, appState.userId), { name: appState.userName, online: true });
            }
        });
        
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
        main();
    </script>
</body>
</html>
